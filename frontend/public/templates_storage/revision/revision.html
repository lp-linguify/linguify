{% extends 'base.html' %}

{% block content %}
  <div class="container mt-5">
    <div class="text-center mb-5">
      <h1 class="display-4 text-primary">Révision</h1>
    </div>

    <!-- Navigation Rapide -->
    <div class="card shadow-sm mb-5 border-0 rounded-lg">
      <div class="card-body bg-light">
        <div class="d-flex justify-content-around">
          <a href="{% url 'reviewed_vocabulaire_list' %}" class="btn btn-outline-primary btn-lg">Liste des Vocabulaires Révisés</a>
            <a href="{% url 'revision_cards' %}" class="btn btn-outline-warning btn-lg">Voir les Cartes de Révision</a> <!-- Accès aux Cartes de Révision -->
          <a href="{% url 'add_revision' %}" class="btn btn-outline-success btn-lg">Ajouter une Révision</a>
          <label for="importFile" class="btn btn-outline-info btn-lg">Importer des Révisions</label>
          <a href="{% url 'export_revisions' %}" class="btn btn-outline-secondary btn-lg">Exporter les Révisions</a>
        </div>
        <input type="file" id="importFile" name="file" style="display: none;">
      </div>
    </div>

    <!-- Messages Flash -->
    {% if messages %}
      <div class="container mb-4">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} shadow-sm rounded-lg fade show" role="alert">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <!-- Liste des Mots Révisés -->
    <div class="card shadow-sm border-0 rounded-lg mb-5">
      <div class="card-body">
        <h2 class="mb-4 text-primary">Mots Révisés</h2>

        <!-- Formulaire de Recherche -->
        <div class="row mb-4">
          <div class="col-md-6">
            <form class="form-inline" method="GET" action="{% url 'reviewed_vocabulaire_list' %}">
              <div class="input-group">
                <input type="text" name="search" class="form-control" id="search" placeholder="Rechercher..." value="{{ search_query }}">
                <div class="input-group-append">
                  <button type="submit" class="btn btn-primary">Rechercher</button>
                </div>
              </div>
            </form>
          </div>
          <div class="col-md-6 text-right">
            <button class="btn btn-danger btn-lg" id="deleteSelected">Supprimer Sélection</button>
          </div>
        </div>

        {% if page_obj %}
          <form id="bulkDeleteForm" method="POST" action="{% url 'delete_selected_revisions' %}">
            {% csrf_token %}
            <div class="revision-list">
              {% for revision in page_obj %}
                <div class="revision-item card mb-3 border-0 shadow-sm rounded-lg">
                  <div class="card-body bg-light">
                    <div class="form-check mb-2">
                      <input type="checkbox" name="selected_revisions" value="{{ revision.id }}" class="form-check-input">
                      <label class="form-check-label font-weight-bold text-primary">{{ revision.vocabulaire.word }}</label>
                    </div>
                    <p class="card-text"><strong>Traduction:</strong> {{ revision.vocabulaire.translation }}</p>
                    <p class="card-text"><strong>Définition:</strong> {{ revision.vocabulaire.definition }}</p>
                    <p class="card-text"><strong>Exemple:</strong> {{ revision.vocabulaire.example }}</p>
                    <p class="card-text"><strong>Traduction de l'exemple:</strong> {{ revision.vocabulaire.example_translation }}</p>
                    <p class="card-text"><strong>Date de Révision:</strong> {{ revision.revision_date }}</p>
                  </div>
                  <div class="card-footer text-right bg-light">
                    <a href="{% url 'edit_revision' revision.id %}" class="btn btn-primary btn-sm">Modifier</a>
                    <form action="{% url 'delete_revision' revision.id %}" method="post" class="d-inline">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Êtes-vous sûr de vouloir supprimer cette révision ?')">Supprimer</button>
                    </form>
                    <button class="btn btn-info btn-sm ml-2" data-toggle="modal" data-target="#revisionDetails{{ revision.id }}">Détails</button>
                  </div>
                </div>
                <!-- Modal pour les détails de la révision -->
                <div class="modal fade" id="revisionDetails{{ revision.id }}" tabindex="-1" role="dialog" aria-labelledby="revisionDetails{{ revision.id }}Label" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title text-primary" id="revisionDetails{{ revision.id }}Label">{{ revision.vocabulaire.word }} - Détails</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                          <span aria-hidden="true">&times;</span>
                        </button>
                      </div>
                      <div class="modal-body">
                        <p><strong>Traduction:</strong> {{ revision.vocabulaire.translation }}</p>
                        <p><strong>Définition:</strong> {{ revision.vocabulaire.definition }}</p>
                        <p><strong>Exemple:</strong> {{ revision.vocabulaire.example }}</p>
                        <p><strong>Traduction de l'exemple:</strong> {{ revision.vocabulaire.example_translation }}</p>
                        <p><strong>Date de Révision:</strong> {{ revision.revision_date }}</p>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
                      </div>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          </form>

          <!-- Pagination -->
          {% if page_obj.has_other_pages %}
            <nav aria-label="Navigation des révisions">
              <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                  <li class="page-item">
                    <a class="page-link" href="?page=1">Première</a>
                  </li>
                  <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Précédente</a>
                  </li>
                {% endif %}
                {% for num in page_obj.paginator.page_range %}
                  {% if page_obj.number == num %}
                    <li class="page-item active">
                      <span class="page-link">{{ num }}</span>
                    </li>
                  {% else %}
                    <li class="page-item">
                      <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                    </li>
                  {% endif %}
                {% endfor %}
                {% if page_obj.has_next %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}">Suivante</a>
                  </li>
                  <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Dernière</a>
                  </li>
                {% endif %}
              </ul>
            </nav>
          {% endif %}
        {% else %}
          <div class="alert alert-warning text-center" role="alert">
            Aucune révision trouvée.
          </div>
        {% endif %}
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Suppression des révisions sélectionnées
    const deleteSelectedButton = document.getElementById('deleteSelected');
    deleteSelectedButton.addEventListener('click', function () {
      const confirmDelete = confirm('Êtes-vous sûr de vouloir supprimer toutes les révisions sélectionnées ?');
      if (confirmDelete) {
        document.getElementById('bulkDeleteForm').submit();
      }
    });

    // Importation de fichiers
    const importFileInput = document.getElementById('importFile');
    importFileInput.addEventListener('change', function () {
      const file = this.files[0];
      if (file) {
        const confirmImport = confirm(`Êtes-vous sûr de vouloir importer les révisions depuis le fichier ${file.name} ?`);
        if (confirmImport) {
          const formData = new FormData();
          formData.append('file', file);

          fetch('{% url "import_revisions" %}', {
            method: 'POST',
            body: formData,
            headers: {
              'X-CSRFToken': '{{ csrf_token }}'
            }
          })
          .then(response => {
            if (response.ok) {
              window.location.reload(); // Recharge la page après l'importation
            } else {
              throw new Error('Erreur lors de l\'importation des révisions.');
            }
          })
          .catch(error => {
            console.error('Erreur:', error);
            alert('Erreur lors de l\'importation des révisions.');
          });
        }
      }
    });

    // Messages Flash
    const flashMessages = document.querySelectorAll('.alert');
    flashMessages.forEach(function (message) {
      setTimeout(function () {
        message.classList.remove('show');
      }, 3000);
    });
  });
</script>
{% endblock %}
